name: Publish SNZ

on:
  push:
    branches-ignore:
      - 'main' # upstream mirror
  workflow_dispatch:
    inputs:
      force_snz:
        description: "Force SNZ publish even if not on streamliners-main"
        required: false
        default: "false"
      dry_run:
        description: "Do a dry run (no actual publish)"
        required: false
        default: "true"
permissions:
  contents: write
concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json
          run_install: false

      - name: Setup git credentials
        run: |
          git config --global user.email "ci@streamliners.co.nz"
          git config --global user.name "Streamliners CI"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2

      - name: Get CodeArtifact token
        id: codeartifact-token
        run: |
          TOKEN=$(aws codeartifact get-authorization-token \
            --domain streamliners-npm \
            --domain-owner 368438108069 \
            --query authorizationToken --output text)
          echo "CODEARTIFACT_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Configure .npmrc for AWS CodeArtifact
        run: |
          echo "registry=https://streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/" > ~/.npmrc
          echo "//streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/:_authToken=${CODEARTIFACT_TOKEN}" >> ~/.npmrc

      - name: Update all package.json files
        run: node scripts/update-package-jsons.js

      - name: Install dependencies
        run: |
          # Create local .npmrc for publishes from repo root
          echo "registry=https://streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/" > .npmrc
          echo "//streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/:_authToken=${CODEARTIFACT_TOKEN}" >> .npmrc

          pnpm install --no-frozen-lockfile

      - name: Build packages
        run: |
          # Build scripts first
          cd packages/@tinacms/scripts
          pnpm build
          cd ../../..

          pnpm build
          pnpm types
      - name: Validate package versions (semver)
        run: |
          node -e "const fs=require('fs'); const path=require('path'); const semver=require('semver');
          function walk(dir){let results=[]; for(const file of fs.readdirSync(dir,{withFileTypes:true})){const full=path.join(dir,file.name);
            if(file.isDirectory()){ if(file.name==='node_modules') continue; results=results.concat(walk(full)); }
            else if(file.name==='package.json'){ results.push(full); } } return results;}
          const roots=['packages','apps','libs','tools'].filter(d=>fs.existsSync(d));
          const pkgs=roots.flatMap(r=>walk(r));
          const bad=[];
          for(const p of pkgs){
            const j=JSON.parse(fs.readFileSync(p,'utf8')); const v=j.version;
            const why=!v?'missing'
              : (typeof v!=='string' ? ('type '+typeof v)
              : (v.startsWith('workspace:')?'workspace protocol'
              : (!semver.valid(v)?'not valid semver':null)));
            if(why) bad.push({p,v,why});
          }
          if(bad.length){
            console.error('âŒ Invalid/missing versions:');
            for(const b of bad) console.error('- '+b.p+' -> '+JSON.stringify(b.v)+' ('+b.why+')');
            process.exit(1);
          }
          console.log('âœ… All package.json versions are valid semver');"
  
      - name: Debug changeset state
        run: |
          echo "=== Changeset files ==="
          ls -la .changeset/ || echo "No .changeset dir"
          echo ""
          echo "=== Changeset file content ==="
          cat .changeset/*.md | head -20 || echo "No changeset files"
          echo ""
          echo "=== Pre.json if exists ==="
          cat .changeset/pre.json || echo "No pre.json file yet"
          echo ""
          echo "=== Sample package.json content ==="
          cat packages/tinacms/package.json | head -30 || true
          echo ""
          echo "=== Git status ==="
          git status

      # ------------------------------------- #
      # PREVIEW: feature branches -> tag beta
      # ------------------------------------- #
      - name: Publish preview to CodeArtifact with tag=beta 
        if: ${{ github.ref != 'refs/heads/streamliners-main' && (github.event_name != 'workflow_dispatch' || inputs.force_snz != 'true') }}
        run: |
          # Determine if this should be a dry run
          DRY_FLAG=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            DRY_FLAG="${{ inputs.dry_run }}"
          fi

          if [[ "$DRY_FLAG" == "true" ]]; then
            echo "ðŸ” DRY RUN MODE - Preview (Beta)"
            pnpm changeset pre enter beta
            pnpm changeset version
            git add .
            git commit -m "Version packages"
            # pnpm changeset publish 
            pnpm changeset pre exit
          else
            echo "ðŸš€ PUBLISHING - Preview (Beta)"
            pnpm changeset pre enter beta
            pnpm changeset status --verbose || true
            pnpm changeset version 
            git add .
            git diff --cached --quiet || git commit -m "Version packages"
            pnpm changeset publish 
            git push --follow-tags
            pnpm changeset pre exit
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ env.CODEARTIFACT_TOKEN }}

      # ------------------------------------- #
      # STABLE-INTERNAL (SNZ): streamliners-main or forced
      # ------------------------------------- #
      - name: Publish SNZ prerelease to CodeArtifact with tag=snz
        if: ${{ github.ref == 'refs/heads/streamliners-main' || (github.event_name == 'workflow_dispatch' && inputs.force_snz == 'true') }}
        run: |
          # Determine if this should be a dry run
          DRY_FLAG=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            DRY_FLAG="${{ inputs.dry_run }}"
          fi

          if [[ "$DRY_FLAG" == "true" ]]; then
            echo "ðŸ” DRY RUN MODE - SNZ"
            pnpm changeset version --snapshot snz
           # pnpm changeset publish --tag snz --dry-run
          else
            echo "ðŸš€ PUBLISHING - SNZ"
            pnpm changeset version --snapshot snz
            pnpm changeset publish --tag snz
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ env.CODEARTIFACT_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "ðŸ“ Build completed. Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changesets handled version management and publishing." >> $GITHUB_STEP_SUMMARY