name: Publish SNZ

on:
  push:
    branches-ignore:
      - 'main' # upstream mirror
  workflow_dispatch:
    inputs:
      force_snz:
        description: "Force SNZ publish even if not on streamliners-main"
        required: false
        default: "false"
      dry_run:
        description: "Do a dry run (no actual publish)"
        required: false
        default: "true"
permissions:
  contents: write
concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json
          run_install: false

      - name: Setup git credentials
        run: |
          git config --global user.email "ci@streamliners.co.nz"
          git config --global user.name "Streamliners CI"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2

      - name: Get CodeArtifact token
        id: codeartifact-token
        run: |
          TOKEN=$(aws codeartifact get-authorization-token \
            --domain streamliners-npm \
            --domain-owner 368438108069 \
            --query authorizationToken --output text)
          echo "CODEARTIFACT_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Configure .npmrc for AWS CodeArtifact
        run: |
          echo "registry=https://streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/" > ~/.npmrc
          echo "//streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/:_authToken=${CODEARTIFACT_TOKEN}" >> ~/.npmrc

      - name: Update all package.json files
        run: node scripts/update-package-jsons.js

      - name: Fix invalid semver versions
        run: |
          echo "=== Fixing invalid semver versions ==="
          # Find all package.json files and fix invalid semver
          find . -name "package.json" -not -path "*/node_modules/*" -not -path "*/.git/*" | while read file; do
            if [ -f "$file" ]; then
              version=$(jq -r '.version // empty' "$file")
              if [ -n "$version" ]; then
                # Check if version matches X.Y pattern (missing patch)
                if echo "$version" | grep -qE '^[0-9]+\.[0-9]+$'; then
                  new_version="${version}.0"
                  echo "Fixing $file: $version -> $new_version"
                  jq --arg v "$new_version" '.version = $v' "$file" > "${file}.tmp" && mv "${file}.tmp" "$file"
                fi
              fi
            fi
          done
    
          echo "=== After fix - checking versions ==="
          find examples experimental-examples -name "package.json" -not -path "*/node_modules/*" 2>/dev/null | while read file; do
            if [ -f "$file" ]; then
              name=$(jq -r '.name // "unknown"' "$file")
              version=$(jq -r '.version // "no-version"' "$file")
              echo "Package: $name, Version: $version"
            fi
          done

      - name: Install dependencies
        run: |
          # Create local .npmrc for publishes from repo root
          echo "registry=https://streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/" > .npmrc
          echo "//streamliners-npm-368438108069.d.codeartifact.ap-southeast-2.amazonaws.com/npm/tina-cms-snz/:_authToken=${CODEARTIFACT_TOKEN}" >> .npmrc

          pnpm install --no-frozen-lockfile

      - name: Build packages
        run: |
          # Build scripts first
          cd packages/@tinacms/scripts
          pnpm build
          cd ../../..

          pnpm build
          pnpm types

     

      - name: Debug package versions before changeset
        run: |
          echo "=== Checking all package versions ==="
          find packages -name "package.json" -not -path "*/node_modules/*" -exec sh -c '
            name=$(jq -r .name "$1")
            version=$(jq -r .version "$1")
            echo "Package: $name, Version: $version"
          ' _ {} \;
      # ------------------------------------- #
      # PREVIEW: feature branches -> tag beta
      # ------------------------------------- #
      # - name: Publish preview to CodeArtifact with tag=beta 
      #   if: ${{ github.ref != 'refs/heads/streamliners-main' && (github.event_name != 'workflow_dispatch' || inputs.force_snz != 'true') }}
      #   run: |
      #     # Determine if this should be a dry run
      #     DRY_FLAG=""
      #     if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
      #       DRY_FLAG="${{ inputs.dry_run }}"
      #     fi
          
      #     if [[ "$DRY_FLAG" == "true" ]]; then
      #       echo "ðŸ” DRY RUN MODE - Preview (Beta)- suffix {0.0.0-}"
      #       pnpm changeset version --snapshot beta
            
      #     else
      #       echo "ðŸš€ PUBLISHING - Preview (Beta) - suffix {0.0.0-}"
      #       pnpm changeset version --snapshot beta
      #       pnpm changeset publish --tag beta
            
      #     fi
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     NPM_TOKEN: ${{ env.CODEARTIFACT_TOKEN }}

      # ------------------------------------- #
      # STABLE-INTERNAL (SNZ): streamliners-main or forced
      # ------------------------------------- #
      - name: Publish SNZ prerelease to CodeArtifact with tag=snz
        if: ${{ github.ref != 'refs/heads/streamliners-main' && (github.event_name != 'workflow_dispatch' || inputs.force_snz != 'true') }}
        run: |
          # Determine if this should be a dry run
          DRY_FLAG=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            DRY_FLAG="${{ inputs.dry_run }}"
          fi
          
          if [[ "$DRY_FLAG" == "true" ]]; then
            set -euo pipefail

            echo "ðŸ” DRY DISPLAY - SNZ prerelease (no commits, no publish, no push)"
            # Make sure the base ref exists locally and remotely so 'status' can diff cleanly
            git fetch origin streamliners-main:streamliners-main || true
            # Enter prerelease mode so changesets compute snz prerelease versions (e.g., 2.9.0-snz.0)
            pnpm changeset pre enter snz

            # Only run 'status' if the base exists; otherwise skip quietly.
            if git show-ref --verify --quiet refs/remotes/origin/streamliners-main; then
              pnpm changeset status --verbose || true
            else
              echo "â„¹ï¸ Skipping 'changeset status' (origin/streamliners-main not found)."
            fi

            # Materialize the version bump locally (still uncommitted) so we can print exact package@version
            pnpm changeset version

            echo "=== Planned version changes (package@version) ==="
            # List all changed package.json files and print name@version for clarity
            git --no-pager diff --name-only | grep -E '/?package\.json$' | xargs -I{} sh -c 'jq -r ".name+\"@\"+.version" "{}" || true' || true
            echo "==============================================="

            # Revert all working-tree changes so nothing persists
            git reset --hard

            # Leave prerelease mode
            pnpm changeset pre exit

            echo "âœ… Display-only complete. No files committed, no tags created, no publish performed."
            
          else
            echo "ðŸš€ PUBLISHING - Preview (SNZ)"
             # Check if already in pre mode
             if [ ! -f .changeset/pre.json ]; then
                echo "ðŸ”µ Entering pre-release mode"
                pnpm changeset pre enter snz
                echo "=== Contents of pre.json ==="
                cat .changeset/pre.json | python3 -m json.tool
                echo "==========================="
                # Check if any initialVersions are null
                echo "=== Checking for null versions ==="
                cat .changeset/pre.json | python3 -c "import sys, json; data=json.load(sys.stdin); nulls=[k for k,v in data.get('initialVersions',{}).items() if v is None]; print('Packages with null versions:', nulls if nulls else 'None')"
                echo "==========================="

                git add .changeset/pre.json
                git commit -m "Enter prerelease mode" || true
             else
               echo "âœ… Already in pre-release mode"
             fi
           
      
            
      
            # Version packages (creates 2.9.0-snz.x tags)
            pnpm changeset version
            # â­ CRITICAL FIX: Check if pre.json was deleted by changeset version
            if [ ! -f .changeset/pre.json ]; then
              echo "âš ï¸  pre.json was removed by changeset version, re-entering pre-release mode"
              pnpm changeset pre enter snz
              echo "=== Contents of re-created pre.json ==="
              cat .changeset/pre.json | python3 -m json.tool
              echo "==========================="
    
              # Check if any initialVersions are null in re-created pre.json
              echo "=== Checking for null versions in re-created pre.json ==="
              cat .changeset/pre.json | python3 -c "import sys, json; data=json.load(sys.stdin); nulls=[k for k,v in data.get('initialVersions',{}).items() if v is None]; print('Packages with null versions:', nulls if nulls else 'None')"
              echo "==========================="
            fi
            git add .
            git commit -m "Version packages" || true
      
            # Publish
            pnpm changeset publish  --tag snz
            git push --follow-tags
      
            # # Exit pre-release mode
            # pnpm changeset pre exit
            # git add .
            # git commit -m "Exit prerelease mode" || true
            
            # clean up the consumed changesets
            # git rm .changeset/*.md 2>/dev/null || true
            # git checkout HEAD -- .changeset/config.json .changeset/README.md 2>/dev/null || true
    
            # if git diff --cached --quiet; then
            #   echo "No changesets to clean up"
            # else
            #   git commit -m "chore: remove consumed changesets [skip ci]"
            # fi
            #git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ env.CODEARTIFACT_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "ðŸ“ Build completed. Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changesets handled version management and publishing." >> $GITHUB_STEP_SUMMARY